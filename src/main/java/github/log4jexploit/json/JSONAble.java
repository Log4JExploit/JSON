package github.log4jexploit.json;

import github.log4jexploit.json.exceptions.JSONRecursionException;

public interface JSONAble {

    String toJSONString();

    String toJSONString(int recursionDepth);

    boolean isArray();

    boolean isObject();

    JSONObject asObject();

    JSONArray asArray();

    static String toValueString(Object object) {
        if(object instanceof JSONAble obj) {
            return obj.toJSONString();
        } else if(object == null) {
            return "null";
        } else if(Primitives.isPrimitive(object)) {
            return object.toString();
        } else {
            return "\"" + escapeText(object.toString()) + "\"";
        }
    }

    static String toValueString(Object object, int recursionDepth) {
        if(object instanceof JSONAble obj) {
            if(recursionDepth >= JSON.RECURSION_DEPTH_LIMIT)
                throw new JSONRecursionException();
            return obj.toJSONString(recursionDepth + 1);
        } else if(object == null) {
            return "null";
        } else if(Primitives.isPrimitive(object)) {
            return object.toString();
        } else {
            return "\"" + escapeText(object.toString()) + "\"";
        }
    }


    static String escapeText(String text) {
        StringIterator iterator = new StringIterator(text);
        StringBuilder buffer = new StringBuilder();

        do {
            if(iterator.current() == '\"') {
                if(!iterator.hasLast() || iterator.getLast() != '\\') {
                    buffer.append('\\');
                    buffer.append(iterator.current());
                    continue;
                }
            }

            if(iterator.current() == '\\') {
                if (iterator.hasNext()) {
                    char peek = iterator.peek();
                    if (peek != '\\' && peek != '\"') {
                        buffer.append("\\\\");
                        continue;
                    }
                } else {
                    buffer.append("\\\\");
                    continue;
                }
            }

            if(iterator.current() < 32) {
                buffer.append("\\");
            }

            buffer.append(iterator.current());
        } while (iterator.tryAdvance());
        return buffer.toString();
    }
}
